<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="style.css" type="text/css" />
  <script src="flatbuffers.js"></script>
  <script src="../protocol/protocol_generated.js"></script>
</head>
<body>
<div class="container">
  <div class="section header">
      <span class="header-title">LPTC CoderDojo</span>
      <span class="header-logo"></span>
  </div>
  <div class="section container">
    <div class="section">
      <canvas class="feed" width=640 height=480></canvas>
    </div>
    <div class="section">
      <div class="container">
        <div class="section">
          <fieldset>
            <div class="row">
              <label for="topic">Topic ></label>
              <input name="topic" id="topic" type="text" />
            </div>
            <button id="action">Subscribe</button>
          </fieldset>
        </div>
        <div class="section">
          <div class="debug"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  var actionButton = document.getElementById("action");
  var topicInput = document.getElementById("topic");
  var debugConsole = document.querySelector('.debug');
  var feedOn = false;
  var connected = false;
  var canvas = document.querySelector('canvas');
  var ws = new WebSocket("ws://localhost:9002");
  var ctx = canvas.getContext("2d");

  var logToDebugConsole = function(data) {
    var msg = data.msg;
    var cls = data.class || '';
    var msgElem = document.createElement('div');
    msgElem.className = 'debug-msg ' + cls;
    msgElem.textContent = msg;
    debugConsole.appendChild(msgElem);
    debugConsole.scrollTop = debugConsole.scrollHeight;
    console.log(msg);
  };

  ws.binaryType = 'arraybuffer';

  ws.onopen = function() {
    connected = true;
    logToDebugConsole({msg: `‚úÖ Connected to server.`, class: 'evt'});
  };

  ws.onmessage = function(msg) {
    if (typeof msg.data !== "object") {
      logToDebugConsole({msg: `‚ùå  Unexpected WS data encoding`, class: 'itsvr'});
      return;
    }
    const buf = new flatbuffers.ByteBuffer(new Uint8Array(msg.data));
    const message = lptc_coderdojo.protocol.Message.getRootAsMessage(buf);
    const timestamp = new Date(message.timestamp().toFloat64());
    const messageType = message.type();

    if (messageType === lptc_coderdojo.protocol.MessageType.DeviceData) {
      canvas.width = canvas.width;
      ctx.font = "20pt Quicksand";

      const devData = message.data();
      let imageData;
      if (devData.type() === lptc_coderdojo.protocol.DataType.Depth) {
        ctx.fillStyle = "orange";
        imageData = new ImageData(new Uint8ClampedArray(devData.depthArray()), 640, 480);
      } else if (devData.type() === lptc_coderdojo.protocol.DataType.Video) {
        ctx.fillStyle = "green";
        imageData = new ImageData(new Uint8ClampedArray(devData.videoArray()), 640, 480);
      }

      ctx.putImageData(imageData, 0, 0);
      ctx.fillText(timestamp.toISOString(), 310, 465);
    } else if (messageType === lptc_coderdojo.protocol.MessageType.Error) {
      logToDebugConsole({msg: `üì• < ‚ö†Ô∏è [${timestamp.toISOString()}]: ${message.error()}`, class: 'itsvr'});
    }
  };

  ws.onclose = function(ev) {
    connected = false;
    logToDebugConsole({msg: `‚ùå Connection closed (code: ${ev.code})`, class: 'evt'});
  }

  actionButton.onclick = function() {
    const topic = topicInput.value;
    var command;
    if (!feedOn) {
      command = `SUBSCRIBE ${topic}`;
      ws.send(command);
      actionButton.textContent = "Unsubscribe";
      feedOn = true;
    } else {
      command = `UNSUBSCRIBE ${topic}`;
      ws.send(command);
      actionButton.textContent = "Subscribe";
      feedOn = false;
    }
    logToDebugConsole({msg: `üì§ > ${command}`, class: 'clt'});
  }
</script>
</body>
</html>